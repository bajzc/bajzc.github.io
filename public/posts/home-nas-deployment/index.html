<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Home NAS deploment - Random Geek</title><meta name="author" content="Jason Li">
<meta name="author-link" content="">
<meta name="description" content="Contents
Part I - Basic Before All... Choice of Operating System About File System How to install Linux Part II - Network Part III - Docker Docker Network: Frpc Nginx Proxy manager Nextcloud Docker Compose Part IV - Backup Part I - Basic Before All... What is a home NAS? A typical home NAS is used for storing and sharing photos and files. As an extension to traditional NAS, the server config followed by this article would include more applications like offline downloader, media server, and printer server." /><meta name="keywords" content='NAS, docker, linux' />
  <meta itemprop="name" content="Home NAS deploment">
  <meta itemprop="description" content="Contents
Part I - Basic Before All... Choice of Operating System About File System How to install Linux Part II - Network Part III - Docker Docker Network: Frpc Nginx Proxy manager Nextcloud Docker Compose Part IV - Backup Part I - Basic Before All... What is a home NAS? A typical home NAS is used for storing and sharing photos and files. As an extension to traditional NAS, the server config followed by this article would include more applications like offline downloader, media server, and printer server.">
  <meta itemprop="datePublished" content="2024-02-03T19:37:45+07:00">
  <meta itemprop="dateModified" content="2024-02-03T19:37:45+07:00">
  <meta itemprop="wordCount" content="1327">
  <meta itemprop="keywords" content="NAS,Docker,Linux"><meta property="og:url" content="https://bajzc.org/posts/home-nas-deployment/">
  <meta property="og:site_name" content="Random Geek">
  <meta property="og:title" content="Home NAS deploment">
  <meta property="og:description" content="Contents
Part I - Basic Before All... Choice of Operating System About File System How to install Linux Part II - Network Part III - Docker Docker Network: Frpc Nginx Proxy manager Nextcloud Docker Compose Part IV - Backup Part I - Basic Before All... What is a home NAS? A typical home NAS is used for storing and sharing photos and files. As an extension to traditional NAS, the server config followed by this article would include more applications like offline downloader, media server, and printer server.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-03T19:37:45+07:00">
    <meta property="article:modified_time" content="2024-02-03T19:37:45+07:00">
    <meta property="article:tag" content="NAS">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Linux">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Home NAS deploment">
  <meta name="twitter:description" content="Contents
Part I - Basic Before All... Choice of Operating System About File System How to install Linux Part II - Network Part III - Docker Docker Network: Frpc Nginx Proxy manager Nextcloud Docker Compose Part IV - Backup Part I - Basic Before All... What is a home NAS? A typical home NAS is used for storing and sharing photos and files. As an extension to traditional NAS, the server config followed by this article would include more applications like offline downloader, media server, and printer server.">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://bajzc.org/posts/home-nas-deployment/" /><link rel="prev" href="https://bajzc.org/posts/lets-encrypt-gentoo/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Home NAS deploment",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/bajzc.org\/posts\/home-nas-deployment\/"
    },"genre": "posts","keywords": "NAS, docker, linux","wordcount":  1327 ,
    "url": "https:\/\/bajzc.org\/posts\/home-nas-deployment\/","datePublished": "2024-02-03T19:37:45+07:00","dateModified": "2024-02-03T19:37:45+07:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Jason Li"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Random Geek"><span class="header-title-text">Random Geek</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="https://gallery.bajzc.com/"
                
                rel="noopener noreferrer" target="_blank"
              >Photo Gallery</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language-switch">
            <span role="button" aria-label="Select Language" title="Select Language"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item">No more translations</li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Random Geek"><span class="header-title-text">Random Geek</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="https://gallery.bajzc.com/"
                  
                  rel="noopener noreferrer" target="_blank"
                >Photo Gallery</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span><span class="menu-system-item language-switch">
              <span role="button" aria-label="Select Language" title="Select Language">English<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select class="language-select" onchange="location = this.value;"><option disabled>No more translations</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Home NAS deploment</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Jason Li</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/tutorial/" class="post-category" title="Category - Tutorial"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Tutorial</a>&ensp;<a href="/categories/review/" class="post-category" title="Category - Review"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Review</a></span></div><div class="post-meta-line"><span title="published on 2024-02-03 19:37:45"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-03">2024-02-03</time></span>&nbsp;<span title="1327 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1400 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>7 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"></div>
      </div><div class="content" id="content"><div class="document">


<div class="contents topic" id="contents">
<p class="topic-title"><a class="reference internal" href="#top">Contents</a></p>
<ul class="simple">
<li><a class="reference internal" href="#part-i-basic" id="toc-entry-1"><strong>Part I - Basic</strong></a><ul>
<li><a class="reference internal" href="#before-all" id="toc-entry-2">Before All...</a></li>
<li><a class="reference internal" href="#choice-of-operating-system" id="toc-entry-3">Choice of Operating System</a></li>
<li><a class="reference internal" href="#about-file-system" id="toc-entry-4">About File System</a></li>
<li><a class="reference internal" href="#how-to-install-linux" id="toc-entry-5">How to install Linux</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-ii-network" id="toc-entry-6"><strong>Part II - Network</strong></a></li>
<li><a class="reference internal" href="#part-iii-docker" id="toc-entry-7"><strong>Part III - Docker</strong></a><ul>
<li><a class="reference internal" href="#docker-network" id="toc-entry-8">Docker Network:</a></li>
<li><a class="reference internal" href="#frpc" id="toc-entry-9">Frpc</a></li>
<li><a class="reference internal" href="#nginx-proxy-manager" id="toc-entry-10">Nginx Proxy manager</a></li>
<li><a class="reference internal" href="#nextcloud" id="toc-entry-11">Nextcloud</a></li>
<li><a class="reference internal" href="#docker-compose" id="toc-entry-12">Docker Compose</a></li>
</ul>
</li>
<li><a class="reference internal" href="#part-iv-backup" id="toc-entry-13"><strong>Part IV - Backup</strong></a></li>
</ul>
</div>
<div class="section" id="part-i-basic">
<h2><a class="toc-backref" href="#toc-entry-1"><strong>Part I - Basic</strong></a></h2>
<div class="section" id="before-all">
<h3><a class="toc-backref" href="#toc-entry-2">Before All...</a></h3>
<ol class="arabic simple">
<li>What is a home NAS?</li>
</ol>
<p>A typical home NAS is used for storing and sharing photos and files.
As an extension to traditional NAS, the server config followed by this article would include more applications like offline downloader, media server, and printer server...</p>
<ol class="arabic simple" start="2">
<li>Hardware requirement:</li>
</ol>
<p>Any kind of popular architecture (x86, amd64, arm64) CPU, with high-speed network (ethernet, WIFI) and disk (USB3.*, SATA, NVME) interface. I'm not going to stop you from using an Android phone with a type-C to 4*USB (with PD backwards charging) as your cherished server.</p>
<p>Because technically I used such a server for more than 6 months, a Raspberry Pi 4. I had developed a habit to reboot it regularly every 2 days and bear the risk of losing all data.</p>
<p>So, be kind to yourself at this stage. Power and noise worth be considered as part of the budget, and also extension capability.</p>
<p>This is my current hardware, just for reference:</p>
<pre class="literal-block">
cpu:
                      Intel(R) Celeron(R) N5105 &#64; 2.00GHz, 2800 MHz
graphics card:
                      Intel JasperLake [UHD Graphics]
disk:
  /dev/nvme0n1         KIOXIA NVMe SSD  # root disk
  /dev/sda             TOSHIBA MG08ADA8 # data disk
memory:
                      Memory Size: 15 GB
</pre>
</div>
<div class="section" id="choice-of-operating-system">
<h3><a class="toc-backref" href="#toc-entry-3">Choice of Operating System</a></h3>
<p><strong>Linux</strong></p>
<p>Not a nerd? Go for <a class="reference external" href="https://www.synology.com">Synology NAS</a></p>
</div>
<div class="section" id="about-file-system">
<h3><a class="toc-backref" href="#toc-entry-4">About File System</a></h3>
<p>I'm currently using Btrfs, which is a native Linux file system that has lots of modern features attracts me:</p>
<ol class="arabic simple">
<li>CoW (copy on write): File won't be overwritten partially and then broken after a sudden power outage</li>
<li>Compression: save your disk and money</li>
<li>Subvolume and snapshot: save your data from accident such as you deleted your system (you won't, right?)</li>
</ol>
</div>
<div class="section" id="how-to-install-linux">
<h3><a class="toc-backref" href="#toc-entry-5">How to install Linux</a></h3>
<p>I believe there are thousands of tutorials for beginners.</p>
<p><a class="reference external" href="https://wiki.archlinux.org/title/Installation_guide">Join the Arch &quot;cult&quot;</a></p>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:Main_Page">I don't trust any binary distro, I want to compile everything, where should I start?</a></p>
<p><a class="reference external" href="https://www.debian.org/releases/stable/installmanual">I just want a normal and stable one</a></p>
</div>
</div>
<div class="section" id="part-ii-network">
<h2><a class="toc-backref" href="#toc-entry-6"><strong>Part II - Network</strong></a></h2>
<blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>2024.2.11 Update:</p>
<p>I switched to use <strong>cloudflare</strong> as my domain host, they provided some useful features:</p>
<ol class="last arabic simple">
<li>I can create a tunnel between cloudflare server and my server, which means when I enable cloudflare WARP on my client, the delay can very much reduce to 50ms.</li>
<li>DDoS-protection, although I don't think there is any point to attract a personal Blog.</li>
</ol>
</div>
</blockquote>
<object data="/images/NAS-network.svg" type="image/svg+xml">/images/NAS-network.svg</object>
<p>As far as I know, many ISPs (Internet Service Provider) block <strong>Port</strong> 80 and 443, which basically means you can not access directly to the web page.
There are many workarounds: use another port instead and specify it when you access; use IPv6 instead but 80 and 443 may still be blocked; use a reverse proxy server but with higher delay.</p>
<p>I'm using <a class="reference external" href="https://github.com/fatedier/frp">frp</a> as my reverse proxy software. A reverse proxy server means all your data will pass through a server held by others, so for those highly concerned about security, check out my previous post <a class="reference external" href="https://bajzc.com/posts/lets-encrypt-gentoo/">here</a></p>
<p><strong>Frpc</strong> (client side) listens to a server at a specific port, your DNS record should point to that server. Once a request is made, the server will pass it to you according to the domain name, then frpc will forward it to the right application.</p>
<p>To be clear, frpc is still an application behind the firewall and inside docker. So if you are using IPv4 only, you can block all ports other than the one frpc is using. (only TCP)</p>
<p>Here is my frpc config file:</p>
<pre class="literal-block">
[common]
server_addr = frp2.freefrp.net  # proxy server you are using
server_port = 7000              # port given by the server holder, default: 7000
token = freefrp.net             # password, here the server is for public: https://freefrp.net/

[ipv4_bajzc_com_http]           # a unique entity
type = http                     # proxy type
local_ip = 10.5.0.3             # local server address
local_port = 80                 # local server port
custom_domains = ipv4.bajzc.com # URL you use to access this application

[ipv4_bajzc_com_https]
type = https
local_ip = 10.5.0.3
local_port = 443
custom_domains = ipv4.bajzc.com

......
</pre>
<p>A single frpc cannot stand, you need a <strong>frps</strong> (server) and correct DNS records.
A frp server could be a VPS you buy from big cloud computing company, or from <strong>&quot;kind&quot;</strong> people share their resources.
(Again, people concerned about security should check out my previous post <a class="reference external" href="https://bajzc.com/posts/lets-encrypt-gentoo/">here</a>)</p>
<p>My DNS records as reference:</p>
<div class="figure align-center">
<img alt="/images/DNS-records.png" src="/images/DNS-records.png" />
<p class="caption">DNS-records</p>
</div>
</div>
<div class="section" id="part-iii-docker">
<h2><a class="toc-backref" href="#toc-entry-7"><strong>Part III - Docker</strong></a></h2>
<p>Suppose you overcome all difficulties and get your network and disk working now.</p>
<p>This article is mainly focusing on a Linux environment. Thanks to the portability of <a class="reference external" href="https://www.docker.com/">Docker</a>, it could also apply to a Windows server, but comes at the expense of performance.</p>
<div class="figure align-center">
<object data="/images/Docker-structure.svg" type="image/svg+xml">/images/Docker-structure.svg</object>
<p class="caption">Docker applications structures</p>
</div>
<p>Here, address in yellow show the IP behind local subnet, which can only be access by local applications.
The NPM (nginx proxy manager) is used to handle all access for all domains and warp them with HTTPS.</p>
<div class="section" id="docker-network">
<h3><a class="toc-backref" href="#toc-entry-8">Docker Network:</a></h3>
<pre class="code yaml literal-block">
<span class="name tag">networks</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="name tag">redisnet</span><span class="punctuation">:</span><span class="whitespace">                         </span><span class="comment single"># cache for Nextcloud</span><span class="whitespace">
  </span><span class="name tag">NPM</span><span class="punctuation">:</span><span class="whitespace">                              </span><span class="comment single"># all apps should be under this subnet</span><span class="whitespace">
    </span><span class="name tag">driver</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">bridge</span><span class="whitespace">
    </span><span class="name tag">ipam</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">config</span><span class="punctuation">:</span><span class="whitespace">
        </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="name tag">subnet</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">10.5.0.0/16</span><span class="whitespace">
  </span><span class="name tag">qb-ipv6</span><span class="punctuation">:</span><span class="whitespace">                          </span><span class="comment single"># for IPv6 download</span><span class="whitespace">
    </span><span class="name tag">enable_ipv6</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">true</span><span class="whitespace">
    </span><span class="name tag">driver</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">bridge</span><span class="whitespace">
    </span><span class="name tag">ipam</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">driver</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">default</span><span class="whitespace">
      </span><span class="name tag">config</span><span class="punctuation">:</span><span class="whitespace">
        </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="name tag">subnet</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">2001:3200:3200::/64</span><span class="whitespace">
          </span><span class="name tag">gateway</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">2001:3200:3200::1</span>
</pre>
</div>
<div class="section" id="frpc">
<h3><a class="toc-backref" href="#toc-entry-9">Frpc</a></h3>
<pre class="code yaml literal-block">
<span class="name tag">frp</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="name tag">restart</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">always</span><span class="whitespace">                           </span><span class="comment single"># auto start after a reboot</span><span class="whitespace">
  </span><span class="name tag">image</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">snowdreamtech/frpc:0.51.0</span><span class="whitespace">
  </span><span class="name tag">container_name</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">frpc</span><span class="whitespace">
  </span><span class="name tag">network_mode</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal string">&quot;host&quot;</span><span class="whitespace">                      </span><span class="comment single"># use the host network</span><span class="whitespace">
  </span><span class="name tag">volumes</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="comment single"># mount the config file dir into docker container (read only)</span><span class="whitespace">
    </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">/all-docker-data/frp:/etc/frp:ro</span>
</pre>
</div>
<div class="section" id="nginx-proxy-manager">
<h3><a class="toc-backref" href="#toc-entry-10">Nginx Proxy manager</a></h3>
<pre class="code yaml literal-block">
<span class="name tag">NPM</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="name tag">image</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">jc21/nginx-proxy-manager:latest</span><span class="whitespace">
  </span><span class="name tag">container_name</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">nginx-proxy-manager</span><span class="whitespace">
  </span><span class="name tag">restart</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">unless-stopped</span><span class="whitespace">
  </span><span class="name tag">networks</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="name tag">NPM</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">ipv4_address</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">10.5.0.3</span><span class="whitespace">                        </span><span class="comment single"># address frpc should point to</span><span class="whitespace">
  </span><span class="name tag">ports</span><span class="punctuation">:</span><span class="whitespace">
</span><span class="comment single">#      - &quot;0.0.0.0:81:81&quot;                            # Admin WebUI, disable after setup</span><span class="whitespace">
    </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal string">&quot;[::]:81:80&quot;</span><span class="whitespace">                                  </span><span class="comment single"># For IPv6 access (The default is block byb 3BB -_-)</span><span class="whitespace">
    </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal string">&quot;[::]:444:443&quot;</span><span class="whitespace">
  </span><span class="name tag">volumes</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">/.../NPM/data:/data</span><span class="whitespace">                           </span><span class="comment single"># WebUI data</span><span class="whitespace">
    </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">/.../NPM/letsencrypt:/etc/letsencrypt</span><span class="whitespace">         </span><span class="comment single"># https certificates</span>
</pre>
<p><a class="reference external" href="https://nginxproxymanager.com/">Offical website</a></p>
<p>After you login to the WebUI, setup a proxy like this:</p>
<img alt="/images/NPM-sample.png" class="align-center" src="/images/NPM-sample.png" style="width: 400px;" />
<p>HTTPS:</p>
<img alt="/images/NPM-SSL.png" class="align-center" src="/images/NPM-SSL.png" style="width: 400px;" />
</div>
<div class="section" id="nextcloud">
<h3><a class="toc-backref" href="#toc-entry-11">Nextcloud</a></h3>
<p><a class="reference external" href="https://nextcloud.com">Nextcloud</a>: It is a suite of client-server software for creating and using file hosting services.</p>
<pre class="code yaml literal-block">
<span class="name tag">db</span><span class="punctuation">:</span><span class="whitespace">                                         </span><span class="comment single"># database</span><span class="whitespace">
    </span><span class="name tag">image</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">mariadb:10.6</span><span class="whitespace">
    </span><span class="name tag">restart</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">always</span><span class="whitespace">
    </span><span class="name tag">command</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">--transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW</span><span class="whitespace">
    </span><span class="name tag">volumes</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">/.../nextcloud/db:/var/lib/mysql</span><span class="whitespace">
    </span><span class="name tag">environment</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_ROOT_PASSWORD=CHANGEME</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_PASSWORD=CHANGEME</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_DATABASE=nextcloud</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_USER=nextcloud</span><span class="whitespace">

</span><span class="whitespace error">  </span><span class="name tag">redis</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="name tag">image</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">redis:alpine</span><span class="whitespace">
    </span><span class="name tag">restart</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">always</span><span class="whitespace">
    </span><span class="name tag">networks</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">redisnet</span><span class="whitespace">
    </span><span class="name tag">expose</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">6379</span><span class="whitespace">

  </span><span class="name tag">nextcloud</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="name tag">image</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">nextcloud</span><span class="whitespace">
    </span><span class="name tag">restart</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">always</span><span class="whitespace">
    </span><span class="name tag">depends_on</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">db</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">redis</span><span class="whitespace">
    </span><span class="name tag">links</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">db</span><span class="whitespace">
    </span><span class="name tag">volumes</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">/.../nextcloud/html:/var/www/html</span><span class="whitespace">             </span><span class="comment single"># all your files</span><span class="whitespace">
    </span><span class="name tag">environment</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">REDIS_HOST=redis</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_PASSWORD=CHANGEME</span><span class="whitespace">             </span><span class="comment single"># same password as in db</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_DATABASE=nextcloud</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_USER=nextcloud</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">MYSQL_HOST=db</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">PHP_MEMORY_LIMIT=1024M</span><span class="whitespace">
      </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">PHP_UPLOAD_LIMIT=1024M</span><span class="whitespace">
    </span><span class="name tag">networks</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">redisnet</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">default</span><span class="punctuation">:</span><span class="whitespace">
      </span><span class="name tag">NPM</span><span class="punctuation">:</span><span class="whitespace">
        </span><span class="name tag">ipv4_address</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">10.5.0.5</span>
</pre>
<p><a class="reference external" href="https://github.com/nextcloud/docker/tree/master/.examples">Offical examples</a></p>
<p>Nextcloud requires some small tuning, check out the auto health-check in setting (click your account icon), and edit <tt class="docutils literal"><span class="pre">/.../nextcloud/html/config/config.php</span></tt> according to the document.</p>
<p>If Nextcloud is behind NPM, you need to add its address to <tt class="docutils literal">trusted_domains</tt> and <tt class="docutils literal">trusted_proxies</tt>, for me:</p>
<pre class="code php literal-block">
<span class="other">'trusted_domains' =&gt;
array (
  0 =&gt; 'cloud.bajzc.com',
  1 =&gt; '10.5.0.5',
  2 =&gt; '10.5.0.3',
  3 =&gt; 'cloud6.bajzc.com',
),
'trusted_proxies' =&gt;
array (
  0 =&gt; '10.5.0.0/16',
),</span>
</pre>
<p>As NPM is using HTTP to communicate with Nextcloud:</p>
<pre class="code php literal-block">
<span class="other">'overwriteprotocol' =&gt; 'https',
'overwritecondaddr' =&gt; '^10\\.5\\.0\\.3$',   // NPM address here
'forwarded-for-headers' =&gt;
array (
  0 =&gt; 'X-Forwarded-For',
  1 =&gt; 'HTTP_X_FORWARDED_FOR',
),</span>
</pre>
</div>
<div class="section" id="docker-compose">
<h3><a class="toc-backref" href="#toc-entry-12">Docker Compose</a></h3>
<p>All the config scripts I shared are part of the final <tt class="docutils literal"><span class="pre">docker-compose.yml</span></tt> file.</p>
<p>Install <strong>docker</strong> and <a class="reference external" href="https://docs.docker.com/compose/install/linux/">docker-compose</a>, edit your <tt class="docutils literal"><span class="pre">docker-compose.yml</span></tt> and run <tt class="docutils literal">docker compose up <span class="pre">-d</span></tt> under the same folder to start all the applications.</p>
</div>
</div>
<div class="section" id="part-iv-backup">
<h2><a class="toc-backref" href="#toc-entry-13"><strong>Part IV - Backup</strong></a></h2>
<p>Considering that you may store lots of personal data, such as photos and documents remotely on this server, you should carefully consider the backup issue.</p>
<p>Tools like snapper could be use to prevent from typing something wrong: <tt class="docutils literal">rm <span class="pre">-r</span> /</tt> instead of <tt class="docutils literal">rm <span class="pre">-r</span> ./</tt>. Unfortunately，these tools can not help you save data when a hard disk fault happened.</p>
<p>So, build a RAID array or LVM RAID would be nice, but this require you to have have two or more disks with same size, which are usually more expensive than your server...</p>
<p>Use cold backup, instead, allow you backup with disk with different size. For example, I use an 8TB HDD for the online storage and two 2TB disks for cold backup (offline).</p>
</div>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-02-03 19:37:45">Updated on 2024-02-03&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/home-nas-deployment/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://bajzc.org/posts/home-nas-deployment/" data-title="Home NAS deploment" data-hashtags="NAS,docker,linux"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://bajzc.org/posts/home-nas-deployment/" data-hashtag="NAS"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://bajzc.org/posts/home-nas-deployment/" data-title="Home NAS deploment"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/nas/" class="post-tag" title="Tags - NAS">NAS</a><a href="/tags/docker/" class="post-tag" title="Tags - Docker">Docker</a><a href="/tags/linux/" class="post-tag" title="Tags - Linux">Linux</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/lets-encrypt-gentoo/" class="post-nav-item" rel="prev" title="Let&#39;s encrypt! (Gentoo)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Let&#39;s encrypt! (Gentoo)</a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript" rel="external nofollow noopener noreferrer">Disqus</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.129.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">Jason Li</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="View Comments"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><script src="https://bajzc.disqus.com/embed.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
